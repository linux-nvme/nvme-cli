---
name: micron-build

on:
  push:
    branches: [mingw]  # Changed from master
  pull_request:
    branches: [mingw]  # Changed from master

  workflow_dispatch:

jobs:
  nvme-cli:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        buildtype: [debug, release]
    container:
      image: ghcr.io/linux-nvme/debian.python:latest
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          scripts/build.sh -b ${{ matrix.buildtype }} -c ${{ matrix.compiler }} -x
      - uses: actions/upload-artifact@v5
        name: upload logs
        if: failure()
        with:
          name: logs files
          path: |
            .build-ci/meson-logs/*.txt

  libnvme:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        buildtype: [debug, release]
    container:
      image: ghcr.io/linux-nvme/debian.python:latest
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          scripts/build.sh -b ${{ matrix.buildtype }} -c ${{ matrix.compiler }} -x libnvme
      - uses: actions/upload-artifact@v5
        name: upload logs
        if: failure()
        with:
          name: libnvme logs files
          path: |
            .build-ci/meson-logs/*.txt

  cross:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: armhf
          - arch: s390x
          - arch: ppc64le
    steps:
      - uses: actions/checkout@v5

      # enable foreign arch (replace unverified dbhi/qus with verified Docker QEMU setup)
      - name: Enable QEMU for cross-arch
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm,ppc64le,s390x

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # compile and run unit tests (replace unverified mosteo-actions/docker-run with native docker run)
      - name: compile and run unit tests
        run: |
          set -eux
          docker pull --platform linux/amd64 ghcr.io/linux-nvme/ubuntu-cross-${{ matrix.arch }}:latest
          docker run --rm \
            --platform linux/amd64 \
            -v "${{ github.workspace }}:/build" \
            -w /build \
            ghcr.io/linux-nvme/ubuntu-cross-${{ matrix.arch }}:latest \
            bash -lc '
              git config --global --add safe.directory /build
              scripts/build.sh -b release -c gcc -t ${{ matrix.arch }} cross
            '

      - uses: actions/upload-artifact@v5
        name: upload logs
        if: failure()
        with:
          name: log files
          path: |
            .build-ci/meson-logs/*.txt

  fallback-shared-libraries:
    name: fallback shared libraries
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/linux-nvme/debian:latest
    if: github.ref == 'refs/heads/mingw'  # Changed from master
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          scripts/build.sh -b release -c gcc fallback
      - uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: log files
          path: |
            .build-ci/meson-logs/*.txt

  build-muon:
    name: muon minimal static
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/linux-nvme/debian:latest
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          scripts/build.sh -m muon

  build-make-static:
    name: make static
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/linux-nvme/debian:latest
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          make static

  build-distro:
    name: build libnvme and nvme-cli separately
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/linux-nvme/debian:latest
    steps:
      - uses: actions/checkout@v5
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: build
        run: |
          scripts/build.sh distro
